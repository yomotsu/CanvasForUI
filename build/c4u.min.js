window.C4U={},C4U.init=function(e){var t=this;this.$canvas=$(e),this.ctx=this.$canvas[0].getContext("2d"),this.$distCanvas=$("<canvas/>"),this.distCtx=this.$distCanvas[0].getContext("2d"),this.WIDTH=this.$canvas.attr("width"),this.HEIGHT=this.$canvas.attr("height"),this.items=[],this.pointerPosition={x:0,y:0};var n=function(e){var t=C4U.$canvas.offset(),n=e.pageX-t.left,r=e.pageY-t.top;C4U.pointerPosition={x:n,y:r}};$(window).on("mousemove",n),this.$canvas.on("click",function(e){n(e);var r=t.pointerPosition.x,i=t.pointerPosition.y;result=t.hitTest(r,i),!result||result.trigger("click")})},C4U.Item=function(e){},C4U.Item.prototype.initialize=function(e){this.color="#000",this.visible=!0,this.opacity=1,this.blendMode="normal",this.width=e.width,this.height=e.height,this.position={x:e.width/2,y:e.height/2},this.rotation=0,C4U.items.push(this)},C4U.Item.prototype.getBounds=function(){var e={top:-10,right:5,bottom:5,left:-5};return console.log(e),e},C4U.Item.prototype.draw=function(){if(!this.visible)return;C4U.ctx.save(),C4U.ctx.beginPath(),C4U.ctx.globalAlpha=this.opacity||1;var e=this.width/-2,t=this.height/-2,n=this.position.x,r=this.position.y,i=this.rotation*Math.PI/180;if(this.blendMode!=="normal"){var s=C4U.blend(this,C4U.ctx.getImageData(e+n,t+r,this.width,this.height));C4U.ctx.drawImage(C4U.$distCanvas[0],e+n,t+r)}else C4U.ctx.setTransform(Math.cos(i),Math.sin(i),-Math.sin(i),Math.cos(i),n,r),this instanceof C4U.Raster?C4U.ctx.drawImage(this.img,e,t):(C4U.ctx.fillStyle=this.color,C4U.ctx.fillRect(e,t,this.width,this.height));C4U.ctx.restore()},C4U.Item.prototype.select=function(){C4U.ctx.save();var e=this.position.x,t=this.position.y,n=this.rotation*Math.PI/180;C4U.ctx.setTransform(Math.cos(n),Math.sin(n),-Math.sin(n),Math.cos(n),e,t);var r=this.position.x-this.width/2,i=this.position.y-this.height/2;C4U.ctx.beginPath(),C4U.ctx.rect(this.width/-2,this.height/-2,this.width,this.height),C4U.ctx.restore()},C4U.Item.prototype.on=function(e,t){var n=this;return this._observer||(this._observer=$({})),this._observer.on(e,function(){var e=arguments;t.apply(n,e)}),this},C4U.Item.prototype.one=function(e,t){var n=this;return this._observer||(this._observer=$({})),this._observer.one(e,function(){var e=arguments;t.apply(n,e)}),this},C4U.Item.prototype.off=function(){return this._observer?this:(this._observer.off.apply(this,arguments),this)},C4U.Item.prototype.trigger=function(){return this._observer?(this._observer.trigger.apply(this._observer,arguments),this):this},C4U.Rect=function(e,t){var n={width:e,height:t};this.initialize(n)},C4U.Rect.prototype=new C4U.Item,C4U.Raster=function(e){this.img=e;var t={width:e.width,height:e.height};this.initialize(t)},C4U.Raster.prototype=new C4U.Item,C4U.render=function(){C4U.ctx.clearRect(0,0,C4U.WIDTH,C4U.HEIGHT),$.each(C4U.items,function(e){this.draw()})},C4U.hitTest=function(e,t){var n=C4U.items.length-1,r,i;return $.each(C4U.items,function(s){C4U.ctx.restore(),r=C4U.items[n-s],r.select();if(C4U.ctx.isPointInPath(e,t))return i=r,!1}),i},C4U.blend=function(e,t){bounds=e.getBounds();var n=e.width,r=e.height,i=e.blendMode;C4U.$distCanvas.attr({width:n,height:r}),C4U.distCtx.clearRect(0,0,n,r);var s=e.position.x,o=e.position.y,u=e.rotation*Math.PI/180;C4U.distCtx.setTransform(Math.cos(u),Math.sin(u),-Math.sin(u),Math.cos(u),s,o),C4U.distCtx.drawImage(e.img,-s,-o),C4U.ctx.restore();var a=C4U.distCtx.getImageData(0,0,n,r),e=a.data,f=t.data,l,c,h=f.length,p,d,v,m,g,y,b,w;for(var E=0;E<h;E+=4){l=e[E+3]/255,c=f[E+3]/255,b=l+c-l*c,f[E+3]=b*255,p=e[E]/255*l,m=f[E]/255*c,d=e[E+1]/255*l,g=f[E+1]/255*c,v=e[E+2]/255*l,y=f[E+2]/255*c,w=255/b;switch(i){case"normal":case"src-over":f[E]=(p+m-m*l)*w,f[E+1]=(d+g-g*l)*w,f[E+2]=(v+y-y*l)*w;break;case"screen":f[E]=(p+m-p*m)*w,f[E+1]=(d+g-d*g)*w,f[E+2]=(v+y-v*y)*w;break;case"multiply":f[E]=(p*m+p*(1-c)+m*(1-l))*w,f[E+1]=(d*g+d*(1-c)+g*(1-l))*w,f[E+2]=(v*y+v*(1-c)+y*(1-l))*w;break;case"difference":f[E]=(p+m-2*Math.min(p*c,m*l))*w,f[E+1]=(d+g-2*Math.min(d*c,g*l))*w,f[E+2]=(v+y-2*Math.min(v*c,y*l))*w;break;case"src-in":b=l*c,w=255/b,f[E+3]=b*255,f[E]=p*c*w,f[E+1]=d*c*w,f[E+2]=v*c*w;break;case"plus":case"add":b=Math.min(1,l+c),f[E+3]=b*255,w=255/b,f[E]=Math.min(p+m,1)*w,f[E+1]=Math.min(d+g,1)*w,f[E+2]=Math.min(v+y,1)*w;break;case"overlay":f[E]=m<=.5?2*e[E]*m/c:255-(2-2*m/c)*(255-e[E]),f[E+1]=g<=.5?2*e[E+1]*g/c:255-(2-2*g/c)*(255-e[E+1]),f[E+2]=y<=.5?2*e[E+2]*y/c:255-(2-2*y/c)*(255-e[E+2]);break;case"hardlight":f[E]=p<=.5?2*f[E]*p/c:255-(2-2*p/l)*(255-f[E]),f[E+1]=d<=.5?2*f[E+1]*d/c:255-(2-2*d/l)*(255-f[E+1]),f[E+2]=v<=.5?2*f[E+2]*v/c:255-(2-2*v/l)*(255-f[E+2]);break;case"colordodge":case"dodge":e[E]==255&&m==0?f[E]=255:f[E]=Math.min(255,f[E]/(255-e[E]))*w,e[E+1]==255&&g==0?f[E+1]=255:f[E+1]=Math.min(255,f[E+1]/(255-e[E+1]))*w,e[E+2]==255&&y==0?f[E+2]=255:f[E+2]=Math.min(255,f[E+2]/(255-e[E+2]))*w;break;case"colorburn":case"burn":e[E]==0&&m==0?f[E]=0:f[E]=(1-Math.min(1,(1-m)/p))*w,e[E+1]==0&&g==0?f[E+1]=0:f[E+1]=(1-Math.min(1,(1-g)/d))*w,e[E+2]==0&&y==0?f[E+2]=0:f[E+2]=(1-Math.min(1,(1-y)/v))*w;break;case"darken":case"darker":f[E]=(p>m?m:p)*w,f[E+1]=(d>g?g:d)*w,f[E+2]=(v>y?y:v)*w;break;case"lighten":case"lighter":f[E]=(p<m?m:p)*w,f[E+1]=(d<g?g:d)*w,f[E+2]=(v<y?y:v)*w;break;case"exclusion":f[E]=(m+p-2*m*p)*w,f[E+1]=(g+d-2*g*d)*w,f[E+2]=(y+v-2*y*v)*w;break;default:f[E]=f[E+3]=255,f[E+1]=E%8==0?255:0,f[E+2]=E%8==0?0:255}}C4U.distCtx.putImageData(t,0,0)},C4U.update=function(e){var t=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}();t(e)};